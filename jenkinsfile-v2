pipeline {
  agent any

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  environment {
    AWS_REGION = 'us-west-2'
    TF_IN_AUTOMATION = 'true'
    TF_INPUT = 'false'
  }

  stages {

    stage('Checkout') {
      steps {
        cleanWs()
        checkout scm
      }
    }

    stage('Detect Context') {
      steps {
        script {
          env.IS_PR = (env.CHANGE_ID ? "true" : "false")

          if (env.IS_PR == "true") {
            env.TARGET_ENV = "dev"
            env.DEPLOY = "false"
          } else if (env.BRANCH_NAME == "dev") {
            env.TARGET_ENV = "dev"
            env.DEPLOY = "true"
          } else if (env.BRANCH_NAME == "staging") {
            env.TARGET_ENV = "staging"
            env.DEPLOY = "true"
          } else if (env.BRANCH_NAME == "main") {
            env.TARGET_ENV = "prod"
            env.DEPLOY = "true"
          } else if (env.BRANCH_NAME.startsWith("feature/")) {
            env.TARGET_ENV = "dev"
            env.DEPLOY = "false"
          } else {
            env.TARGET_ENV = "dev"
            env.DEPLOY = "false"
          }

          echo "BRANCH_NAME=${env.BRANCH_NAME}, IS_PR=${env.IS_PR}, TARGET_ENV=${env.TARGET_ENV}, DEPLOY=${env.DEPLOY}"
        }
      }
    }

    stage('AWS Identity Check (Role-based)') {
      steps {
        sh '''
          aws --version
          aws sts get-caller-identity
        '''
      }
    }

    stage('Terraform Format') {
      steps {
        sh 'terraform fmt -check -recursive'
      }
    }

    stage('PR / Feature Validation (No Backend)') {
      when {
        expression { return env.IS_PR == "true" || env.BRANCH_NAME.startsWith("feature/") }
      }
      steps {
        sh '''
          terraform init -backend=false
          terraform validate
          terraform workspace list || true
          terraform plan -lock=false -var="environment=dev" -out=tfplan
        '''
      }
    }

    stage('Init (With Backend)') {
      when {
        expression { return env.DEPLOY == "true" }
      }
      steps {
        sh 'terraform init'
      }
    }

    stage('Select/Create Workspace') {
      when {
        expression { return env.DEPLOY == "true" }
      }
      steps {
        sh """
          terraform workspace select ${TARGET_ENV} || terraform workspace new ${TARGET_ENV}
          echo "Using workspace: $(terraform workspace show)"
        """
      }
    }

    stage('Validate') {
      when { expression { return env.DEPLOY == "true" } }
      steps { sh 'terraform validate' }
    }

    stage('Plan') {
      when { expression { return env.DEPLOY == "true" } }
      steps {
        sh '''
          WS=$(terraform workspace show)
          terraform plan -var="environment=$WS" -out=tfplan
        '''
      }
    }

    stage('Approval Gate (Prod Only)') {
      when { expression { return env.TARGET_ENV == "prod" && env.DEPLOY == "true" } }
      steps {
        input message: "Approve PRODUCTION deployment from branch '${env.BRANCH_NAME}'?"
      }
    }

    stage('Apply') {
      when { expression { return env.DEPLOY == "true" } }
      steps {
        sh '''
          WS=$(terraform workspace show)
          terraform apply -auto-approve -var="environment=$WS" tfplan
        '''
      }
    }
  }

  post {
    always {
      echo "Pipeline finished. TARGET_ENV=${env.TARGET_ENV}"
    }
    failure {
      echo "Pipeline failed. Check IMDS role access, backend permissions, or state lock."
    }
  }
}
